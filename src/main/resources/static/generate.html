<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hujjat To'ldirish</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f7f6; display: flex; justify-content: center; padding: 40px; }

        .card {
            background: white; padding: 30px; border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1); width: 100%; max-width: 500px;
        }

        h2 { text-align: center; color: #333; margin-bottom: 25px; }

        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; font-size: 14px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }

        /* Dinamik inputlar ajralib turishi uchun */
        .dynamic-input { border-left: 4px solid #007bff; background-color: #fcfcfc; }

        button {
            width: 100%; padding: 14px; background-color: #28a745; color: white;
            border: none; border-radius: 6px; font-size: 16px; cursor: pointer; margin-top: 20px;
        }
        button:hover { background-color: #218838; }

        .back-link { display: block; text-align: center; margin-top: 15px; color: #666; text-decoration: none; }
    </style>
</head>
<body>

<div class="card">
    <h2>Ma'lumotlarni Kiriting</h2>

    <form id="docForm">
        <div class="form-group">
            <label>Hujjat Nomi (Nima deb saqlansin?)</label>
            <input type="text" id="fileName" placeholder="Masalan: Shartnoma-2024" required>
        </div>

        <div class="form-group">
            <label>Fayl Turi</label>
            <select id="fileType">
                <option value="DOCX">Word (.docx)</option>
                <option value="PDF">PDF (.pdf)</option>
            </select>
        </div>

        <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">

        <div id="dynamicFields">
            <p style="text-align:center; color:#888;">Kalit so'zlar yuklanmoqda...</p>
        </div>

        <button type="submit" id="submitBtn">Hujjatni Yaratish</button>
    </form>

    <a href="templates.html" class="back-link">‚Üê Orqaga</a>
</div>

<script>
    // --- 1. PARAMETRLARNI OLISH ---
    const urlParams = new URLSearchParams(window.location.search);
    const attachHash = urlParams.get('hash'); // URLdan hashni oldik
    console.log(attachHash)

    const token = localStorage.getItem('accessToken');
    if (!token) window.location.href = "login.html";
    if (!attachHash) { alert("Xatolik: Fayl tanlanmadi!"); window.location.href = "templates.html"; }

    // --- API MANZILLARI ---
    const KEYS_API = `http://localhost:8080/api/placeholder/keys?hash=${attachHash}`; // GET
    const GENERATE_API = "http://localhost:8080/api/placeholder/create-file"; // POST (O'zingiznikiga to'g'irlang)

    const dynamicDiv = document.getElementById('dynamicFields');
    const form = document.getElementById('docForm');

    // --- 2. KEYLARNI YUKLASH ---
    async function loadKeys() {
        try {
            const response = await fetch(KEYS_API, {
                headers: { 'Authorization': 'Bearer ' + token }
            });

            if (!response.ok) throw new Error("Keylarni olib bo'lmadi");

            const keys = await response.json(); // List<String>, masalan: ["##ism", "##sana"]
            renderInputs(keys);

        } catch (error) {
            console.error(error);
            dynamicDiv.innerHTML = "<p style='color:red; text-align:center'>Xatolik: Keylarni yuklab bo'lmadi</p>";
        }
    }

    // --- 3. INPUTLARNI CHIZISH ---
    function renderInputs(keys) {
        dynamicDiv.innerHTML = ""; // Tozalash

        if (keys.length === 0) {
            dynamicDiv.innerHTML = "<p>To'ldiriladigan joylar yo'q ekan.</p>";
            return;
        }

        keys.forEach(key => {
            // Labelni chiroyli qilish: ##ism -> Ism
            let labelText = key.replace(/#/g, '').trim();
            labelText = labelText.charAt(0).toUpperCase() + labelText.slice(1);

            const div = document.createElement('div');
            div.className = 'form-group';

            // Input yaratish
            // name atributiga aynan "##ism" ni beramiz, keyin yig'ish oson bo'ladi
            div.innerHTML = `
                <label>${labelText} (${key})</label>
                <input type="text" name="${key}" class="dynamic-input" placeholder="${key} o'rniga yozing..." required>
            `;
            dynamicDiv.appendChild(div);
        });
    }

    // --- 4. YUBORISH (SUBMIT) ---
    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        // A) Dinamik inputlarni MAP ga yig'ish
        const formData = new FormData(form);
        const placeholdersMap = {};

        // Formadagi barcha inputlarni aylanamiz
        for (const [key, value] of formData.entries()) {
            // Faqat ## bilan boshlanganlarini Mapga qo'shamiz
            if (key.startsWith('#')) {
                placeholdersMap[key] = value;
            }

        }

        // B) User ID ni Tokendan olish (Chunki DTO da userId so'ralgan)
        const userId = getUserIdFromToken(token);

        // C) Yakuniy DTO ni yasash
        const requestDto = {
            userId: userId,                // Long (tokendan oldik)
            attachHash: attachHash,        // UUID
            fileName: document.getElementById('fileName').value, // String
            fileType: document.getElementById('fileType').value, // Enum (DOCX, PDF)
            placeholders: placeholdersMap  // Map<String, String>
        };
        console
        console.log("JONATILAYOTGAN DTO:", requestDto);

        // D) Fetch POST
        try {
            const response = await fetch(GENERATE_API, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify(requestDto)
            });

            if (response.ok) {
                alert("Hujjat muvaffaqiyatli yaratildi!");
                window.location.href = "templates.html"; // Yoki yuklab olishga yo'naltirish
            } else {
                const err = await response.text();
                alert("Xatolik: " + err);
            }
        } catch (e) {
            console.error(e);
            alert("Serverga ulanib bo'lmadi");
        }
    });

    // --- YORDAMCHI: Tokendan ID olish ---
    function getUserIdFromToken(token) {
        try {
            // JWT 3 qismdan iborat: header.payload.signature
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));

            const payload = JSON.parse(jsonPayload);
            return payload.id || payload.userId || 0; // Sizning tokeningizda ID qanday nomlangan bo'lsa
        } catch (e) {
            console.error("Token parse error", e);
            return 0;
        }
    }

    // Sahifa ochilganda ishga tushir
    loadKeys();

</script>

</body>
</html>